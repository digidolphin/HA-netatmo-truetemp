alias: TrueTemp controller (example)
mode: parallel
max: 10

triggers:
  - id: entrance_A
    trigger: template
    for: "00:15:00"
    value_template: >
      {% set sp = state_attr('climate.entrance','temperature') | float(none) %}
      {% set tr = states('sensor.entre_temperature') | float(none) %}
      {% set tv = state_attr('climate.entrance','current_temperature') | float(none) %}
      {{ sp is not none and sp >= 20
         and state_attr('climate.entrance','hvac_action') != 'heating'
         and tr is not none and tv is not none
         and ((tr - tv) | abs) >= 0.5 }}

  - id: entrance_B
    trigger: template
    for: "00:15:00"
    value_template: >
      {% set sp = state_attr('climate.entrance','temperature') | float(none) %}
      {% set hv = state_attr('climate.entrance','hvac_action') %}
      {% set tr = states('sensor.entre_temperature') | float(none) %}
      {% set tv = state_attr('climate.entrance','current_temperature') | float(none) %}
      {{ sp is not none and sp >= 20
         and hv == 'heating'
         and tr is not none and tv is not none
         and (tr - tv) >= 0.5 }}

  - id: entrance_C
    trigger: template
    for: "00:15:00"
    value_template: >
      {% set sp = state_attr('climate.entrance','temperature') | float(none) %}
      {% set hv = state_attr('climate.entrance','hvac_action') %}
      {% set tr = states('sensor.entre_temperature') | float(none) %}
      {% set tv = state_attr('climate.entrance','current_temperature') | float(none) %}
      {{ sp is not none and sp >= 20
         and hv != 'heating'
         and tr is not none and tv is not none
         and (sp - tr) >= 0.5
         and (tr - tv) <= -0.5 }}

actions:
  - variables:
      room_key: "{{ trigger.id.split('_')[0] }}"
      rooms:
        entrance:
          room_name: "Entrance"
          climate_entity: climate.entrance
          ref_entity: sensor.entre_temperature
          window_entity: binary_sensor.ikea_parasoll_front_door_contact
          lock_entity: input_datetime.truetemp_lock_until_entrance

  - choose:
      - conditions:
          - condition: template
            value_template: "{{ rooms.get(room_key) is not none }}"
        sequence:
          - action: script.truetemp_adjust_generic
            data:
              room_name: "{{ rooms[room_key].room_name }}"
              climate_entity: "{{ rooms[room_key].climate_entity }}"
              ref_entity: "{{ rooms[room_key].ref_entity }}"
              window_entity: "{{ rooms[room_key].window_entity }}"
              lock_entity: "{{ rooms[room_key].lock_entity }}"
    default:
      - stop: "Unknown room_key"
